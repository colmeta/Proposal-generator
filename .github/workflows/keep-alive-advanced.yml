name: Keep Render Service Alive (Advanced)

on:
  schedule:
    # Run every 5 minutes (12 times per hour)
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
      - name: Checkout (not needed but good practice)
        uses: actions/checkout@v3
      
      - name: Ping Main Service
        id: ping-main
        run: |
          SERVICE_URL="${RENDER_SERVICE_URL}"
          
          if [ -z "$SERVICE_URL" ]; then
            echo "âŒ RENDER_SERVICE_URL secret not set"
            exit 1
          fi
          
          echo "ðŸŒ Pinging: $SERVICE_URL"
          
          # Try health endpoint first
          HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$SERVICE_URL/api/health" 2>&1 || echo "000")
          
          if [ "$HEALTH_RESPONSE" = "200" ]; then
            echo "âœ… Main service is alive! (HTTP $HEALTH_RESPONSE)"
            echo "status=alive" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Health check failed (HTTP $HEALTH_RESPONSE), trying root endpoint..."
            
            # Try root endpoint to wake up the service
            ROOT_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$SERVICE_URL/" 2>&1 || echo "000")
            
            if [ "$ROOT_RESPONSE" != "000" ]; then
              echo "âœ… Service responded! (HTTP $ROOT_RESPONSE)"
              echo "status=woken" >> $GITHUB_OUTPUT
            else
              echo "âŒ Service not responding"
              echo "status=down" >> $GITHUB_OUTPUT
            fi
          fi
        env:
          RENDER_SERVICE_URL: ${{ secrets.RENDER_SERVICE_URL }}
      
      - name: Ping Background Worker
        if: ${{ secrets.RENDER_WORKER_URL != '' }}
        run: |
          WORKER_URL="${RENDER_WORKER_URL}"
          echo "ðŸ”§ Pinging background worker: $WORKER_URL"
          
          WORKER_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$WORKER_URL/api/health" 2>&1 || echo "000")
          
          if [ "$WORKER_RESPONSE" = "200" ]; then
            echo "âœ… Background worker is alive! (HTTP $WORKER_RESPONSE)"
          else
            echo "âš ï¸  Background worker response: HTTP $WORKER_RESPONSE"
          fi
        env:
          RENDER_WORKER_URL: ${{ secrets.RENDER_WORKER_URL }}
      
      - name: Summary
        run: |
          echo "## Keep-Alive Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Main Service: ${{ steps.ping-main.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

